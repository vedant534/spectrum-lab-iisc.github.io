{% comment %}
  Filter publications by email alias for person pages
  Usage: {% include person_bibliography.liquid email=page.email %}
  
  The papers.bib file uses email aliases (e.g., "css", "abijithj") instead of full emails.
  This template resolves the person's email to their alias using _data/emails.yml
{% endcomment %}

{% assign person_email = include.email %}

{% comment %} Look up the alias for this email from _data/emails.yml {% endcomment %}
{% assign person_alias = nil %}
{% for email_entry in site.data.emails %}
  {% if email_entry[1] == person_email %}
    {% assign person_alias = email_entry[0] %}
    {% break %}
  {% endif %}
{% endfor %}

{% comment %} Fallback: extract alias from email if not found in mapping {% endcomment %}
{% unless person_alias %}
  {% assign person_alias = person_email | split: '@' | first %}
{% endunless %}

{% if person_email %}
  <div class="person-publications">
    {% unless person_email contains 'placeholder.com' %}
    <p class="text-muted mb-3"><small>Showing publications for: {{ person_email }}</small></p>
    {% endunless %}
    
    {% comment %} Show all publications and let JavaScript handle filtering based on alias {% endcomment %}
    <ol class="bibliography" id="person-bibliography">
    {% bibliography %}
    </ol>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const personAlias = '{{ person_alias }}';
      const personEmail = '{{ person_email }}';
      const bibliographyList = document.getElementById('person-bibliography');
      const allItems = bibliographyList.querySelectorAll('li');
      let visibleCount = 0;
      
      allItems.forEach(function(item) {
        const itemText = item.innerHTML.toLowerCase();
        
        // Check if this publication contains the person's alias or full email
        // Using word boundary matching to avoid partial matches
        const aliasPattern = new RegExp('\\b' + personAlias.toLowerCase() + '\\b');
        if (aliasPattern.test(itemText) || itemText.includes(personEmail.toLowerCase())) {
          item.style.display = 'list-item';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Add a message if no publications found
      if (visibleCount === 0) {
        const noResultsMsg = document.createElement('p');
        noResultsMsg.className = 'text-muted';
        noResultsMsg.innerHTML = 'No publications found for this author.';
        bibliographyList.parentNode.insertBefore(noResultsMsg, bibliographyList);
        bibliographyList.style.display = 'none';
      }
    });
    </script>
  </div>
  
{% else %}
  <p class="text-muted">No email address specified for filtering publications.</p>
{% endif %}